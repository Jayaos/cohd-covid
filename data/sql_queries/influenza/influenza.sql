----------
-- export influenza cohort in 2014-2019, narrow, no previous observation required
----------

-- Prevent the count and warining messages from showing up in the text file results
SET NOCOUNT ON;
SET ANSI_WARNINGS OFF

-- If you don't have BULK permission, just load the iatrogenic concept IDs straight from values
SELECT *
INTO #iatrogenic_codes
FROM
(VALUES 
(19472), (19493), (19554), (25698), (73395), (73673), (75721), (76002), (76887), (78650), (79240), (80008), (80269), (80286), (80593), (132781), (133088), (133650), (134116), (135722),
(136580), (137443), (138056), (138299), (138667), (142026), (194847), (195981), (196613), (197444), (198928), (199991), (200447), (200616), (200618), (200906), (200907), (201461), (257755), (259992),
(312773), (313643), (313928), (315719), (316577), (320299), (321179), (321462), (321483), (373087), (373105), (373172), (373449), (374430), (374835), (375504), (376095), (378298), (432303), (432499),
(432506), (432508), (432512), (432515), (432518), (432522), (432525), (432528), (432535), (432777), (432789), (432796), (432798), (432809), (432811), (432812), (432813), (433080), (433083), (433084),
(433094), (433096), (433100), (433102), (433106), (433119), (433128), (433180), (433370), (433385), (433386), (433388), (433389), (433390), (433392), (433394), (433399), (433647), (433656), (433658),
(433663), (433667), (433678), (433682), (433683), (433919), (433921), (433931), (433932), (433935), (433938), (433943), (433950), (433951), (433952), (434217), (434223), (434234), (434235), (434239),
(434240), (434247), (434260), (434327), (434527), (434528), (434539), (434540), (434546), (434547), (434548), (434552), (434553), (434554), (434555), (434556), (434675), (434814), (434819), (434822),
(434827), (434829), (434833), (434842), (434843), (434844), (434900), (435129), (435137), (435141), (435147), (435149), (435160), (435161), (435163), (435173), (435359), (435416), (435419), (435423),
(435432), (435437), (435440), (435707), (435714), (435718), (435723), (435724), (435725), (435726), (435728), (435730), (435792), (435875), (435980), (435985), (435986), (435999), (436003), (436005),
(436007), (436008), (436009), (436079), (436287), (436293), (436294), (436295), (436296), (436311), (436312), (436314), (436315), (436389), (436581), (436582), (436584), (436588), (436594), (436603),
(436604), (436617), (436618), (436860), (436861), (436862), (436864), (436876), (436883), (436884), (436886), (436891), (437157), (437158), (437159), (437160), (437168), (437169), (437172), (437173),
(437177), (437183), (437185), (437191), (437192), (437194), (437195), (437196), (437197), (437199), (437245), (437432), (437447), (437451), (437456), (437457), (437461), (437469), (437470), (437474),
(437482), (437742), (437743), (437756), (437757), (437760), (437762), (437767), (437768), (437976), (438028), (438037), (438038), (438041), (438042), (438046), (438054), (438120), (438130), (438294),
(438297), (438306), (438311), (438317), (438320), (438323), (438324), (438327), (438330), (438624), (438631), (438632), (438635), (438636), (438637), (438639), (438648), (438649), (438655), (438656),
(438657), (438659), (438661), (438664), (438915), (438925), (438926), (438929), (438930), (438941), (438942), (438945), (438946), (438950), (439191), (439205), (439206), (439207), (439216), (439218),
(439221), (439222), (439223), (439228), (439233), (439234), (439238), (439242), (439408), (439476), (439477), (439481), (439482), (439483), (439484), (439485), (439486), (439487), (439488), (439489),
(439490), (439501), (439525), (439558), (439577), (439578), (439617), (439618), (439619), (439622), (439623), (439625), (439626), (439628), (439629), (439630), (439631), (439632), (439633), (439634),
(439642), (439971), (439972), (439976), (439977), (439981), (439982), (439986), (439989), (439994), (439996), (440000), (440001), (440002), (440005), (440007), (440009), (440014), (440015), (440016),
(440267), (440270), (440271), (440276), (440281), (440291), (440292), (440296), (440298), (440302), (440307), (440309), (440311), (440387), (440584), (440595), (440597), (440603), (440623), (440891),
(440894), (440895), (440910), (440911), (440912), (440919), (440920), (440923), (440924), (440987), (441184), (441189), (441196), (441197), (441198), (441199), (441205), (441206), (441207), (441260),
(441455), (441458), (441467), (441480), (441488), (441492), (441493), (441494), (441731), (441734), (441735), (441744), (441751), (441759), (441769), (441833), (442011), (442012), (442017), (442018),
(442019), (442022), (442028), (442029), (442035), (442036), (442038), (442044), (442120), (442142), (442258), (442303), (442304), (442307), (442319), (442354), (442578), (442601), (442767), (442771),
(442779), (442786), (442791), (442797), (442987), (442988), (443194), (443195), (443197), (443198), (443223), (443224), (443236), (443253), (443273), (443282), (443283), (443339), (443340), (443341),
(443342), (443346), (443347), (443348), (443349), (443351), (443354), (443355), (443367), (443368), (443369), (443370), (443371), (443372), (443373), (443374), (443375), (443377), (443378), (443402),
(443448), (443451), (443504), (443505), (443506), (443507), (443547), (443548), (443559), (443575), (443595), (443602), (443603), (443621), (443623), (443626), (443627), (443703), (443704), (443707),
(443711), (443714), (443758), (443780), (443859), (443862), (443880), (443912), (443915), (443930), (443935), (443952), (443958), (444030), (444038), (444043), (444229), (444230), (444231), (444232),
(444363), (444378), (444387), (444392), (920192), (920195), (920198), (1326629), (1575902), (4004672), (4006482), (4006942), (4008709), (4008710), (4008712), (4008714), (4009318), (4009319), (4009647), (4010406),
(4015597), (4017021), (4017905), (4019854), (4019855), (4019857), (4019859), (4019862), (4019866), (4019867), (4020009), (4020142), (4020145), (4020146), (4020148), (4020149), (4020150), (4020159), (4020166), (4020438),
(4020441), (4020442), (4020447), (4020451), (4020602), (4020725), (4020886), (4020887), (4022082), (4022678), (4024127), (4027133), (4027678), (4027690), (4028485), (4029616), (4029628), (4030596), (4030744), (4031206),
(4031213), (4031741), (4032175), (4032799), (4033866), (4035154), (4035299), (4035653), (4035966), (4035982), (4036793), (4038401), (4040305), (4046818), (4047222), (4047993), (4048685), (4049152), (4049341), (4049343),
(4049765), (4050326), (4050438), (4052011), (4052690), (4053721), (4054926), (4055231), (4055451), (4056690), (4056726), (4056740), (4056743), (4056745), (4056867), (4057190), (4057322), (4057335), (4057612), (4058237),
(4058994), (4059273), (4059403), (4059411), (4059418), (4059430), (4062122), (4062397), (4062540), (4064036), (4065217), (4065249), (4066819), (4067987), (4069320), (4069692), (4070976), (4071693), (4079934), (4080762),
(4081135), (4084011), (4084286), (4084287), (4085586), (4087729), (4088114), (4091711), (4092830), (4093993), (4094074), (4094637), (4094638), (4094639), (4095059), (4095360), (4095498), (4095518), (4095830), (4095832),
(4096135), (4096268), (4096271), (4096278), (4096435), (4096598), (4096879), (4097023), (4097044), (4097479), (4097626), (4097790), (4097925), (4097981), (4098106), (4098825), (4099410), (4099412), (4099883), (4100028),
(4100362), (4100781), (4101143), (4101256), (4102296), (4102350), (4102913), (4102944), (4103126), (4103237), (4103853), (4104609), (4105101), (4106079), (4120090), (4120281), (4121274), (4121617), (4125005), (4125008),
(4125659), (4125968), (4127554), (4128369), (4131500), (4132139), (4136512), (4137236), (4137289), (4137553), (4137934), (4138107), (4138264), (4138820), (4138908), (4139281), (4139421), (4140449), (4141190), (4145123),
(4145549), (4146041), (4146666), (4146735), (4146763), (4147318), (4148708), (4148710), (4148937), (4148941), (4149182), (4149716), (4149832), (4149888), (4150061), (4151050), (4151240), (4151242), (4151380), (4151397),
(4151399), (4151455), (4152658), (4152664), (4153362), (4153686), (4153869), (4155336), (4155501), (4155529), (4156143), (4156147), (4156148), (4156454), (4156465), (4156756), (4157200), (4157204), (4157206), (4157219),
(4157222), (4157223), (4157356), (4157514), (4157670), (4158106), (4158107), (4158108), (4158123), (4158464), (4158582), (4158583), (4158602), (4158714), (4158715), (4159359), (4159511), (4159655), (4159804), (4159810),
(4159892), (4159895), (4159913), (4159914), (4160244), (4160264), (4160371), (4160665), (4160957), (4160961), (4161236), (4161238), (4161347), (4161367), (4161377), (4161489), (4161491), (4161538), (4161622), (4161624),
(4162034), (4162320), (4162322), (4162468), (4162476), (4162485), (4162752), (4162761), (4162908), (4163364), (4163529), (4163690), (4164401), (4164432), (4164546), (4166164), (4166384), (4167181), (4167767), (4168834),
(4168964), (4170069), (4170296), (4170452), (4171697), (4171869), (4173078), (4173431), (4173462), (4173746), (4173772), (4173778), (4173797), (4174724), (4176120), (4176170), (4176586), (4176807), (4176898), (4177492),
(4177768), (4178114), (4179071), (4179185), (4180634), (4180636), (4180711), (4180778), (4180976), (4181811), (4181910), (4182072), (4182686), (4182850), (4183705), (4184438), (4185077), (4185399), (4187232), (4188080),
(4188207), (4188335), (4188595), (4188630), (4189529), (4190706), (4191592), (4192125), (4192127), (4193384), (4193868), (4194050), (4194374), (4194523), (4194981), (4195224), (4195452), (4195813), (4195898), (4196035),
(4196305), (4196620), (4197631), (4197963), (4198021), (4198071), (4198414), (4198758), (4198826), (4199475), (4200058), (4201967), (4202052), (4202497), (4202810), (4203137), (4203152), (4203460), (4203763), (4203846),
(4204036), (4204537), (4206196), (4207198), (4207606), (4207623), (4209423), (4209974), (4210133), (4211012), (4211014), (4211665), (4214262), (4215630), (4215720), (4216256), (4216664), (4217521), (4218193), (4218470),
(4218741), (4219089), (4219202), (4219350), (4220521), (4220853), (4221077), (4223020), (4223197), (4224651), (4224953), (4227727), (4228800), (4228811), (4230779), (4230798), (4231724), (4231999), (4232334), (4232492),
(4232621), (4233224), (4235307), (4235435), (4237138), (4237201), (4237450), (4237906), (4238117), (4239381), (4239812), (4239950), (4240209), (4242391), (4243190), (4244716), (4245385), (4245794), (4245840), (4245871),
(4247116), (4248288), (4249597), (4253210), (4254093), (4259263), (4260539), (4260963), (4261617), (4262818), (4263531), (4263532), (4263569), (4264192), (4264541), (4264649), (4264681), (4264766), (4264889), (4265769),
(4266499), (4266594), (4271051), (4272177), (4272184), (4274196), (4275567), (4275972), (4276494), (4276495), (4276526), (4277354), (4277747), (4280973), (4281542), (4284414), (4284693), (4284993), (4286041), (4287251),
(4287576), (4287703), (4288756), (4289150), (4289615), (4290538), (4294658), (4295116), (4295889), (4296735), (4297288), (4298088), (4299092), (4299094), (4299378), (4299503), (4299644), (4300092), (4300301), (4303206),
(4304736), (4305818), (4306472), (4307098), (4307962), (4308255), (4308256), (4308390), (4308391), (4308394), (4308404), (4308563), (4308713), (4308715), (4308838), (4308843), (4308861), (4308863), (4309001), (4309008),
(4309019), (4309020), (4309158), (4309175), (4309315), (4309318), (4309320), (4309347), (4309477), (4309478), (4309766), (4309917), (4309924), (4309970), (4310082), (4310083), (4310521), (4311219), (4311220), (4311226),
(4311237), (4311273), (4311350), (4312185), (4313135), (4313437), (4314243), (4314244), (4314247), (4314275), (4314372), (4314655), (4314660), (4314668), (4315153), (4315161), (4316189), (4316205), (4317099), (4319417),
(4320635), (4322175), (4322320), (4322698), (4323438), (4323580), (4323851), (4324852), (4325601), (4326409), (4326755), (4326841), (4327348), (4327935), (4329318), (4330222), (4331287), (4331292), (4332640), (4334028),
(4336973), (4337373), (4337692), (4337960), (4338224), (4340367), (4340954), (4341657), (4341658), (4343239), (4345680), (35207518), (35208410), (35208483), (35208484), (35209149), (35209502), (35209503), (35209508), (35210394),
(35210430), (35215316), (35215319), (35215322), (35215325), (35215328), (35215334), (35215337), (35215340), (35215343), (35215346), (35215352), (35215355), (35215358), (35215361), (35215364), (35215370), (35215373), (35215376), (35215379),
(35215382), (35215388), (35215391), (35215394), (35215397), (35215400), (35215406), (35215409), (35215412), (35215415), (35215418), (35215424), (35215427), (35215430), (35215433), (35215436), (35215442), (35215445), (35215448), (35215451),
(35215454), (35215460), (35215463), (35215466), (35215469), (35215472), (35215478), (35215481), (35215484), (35215487), (35215490), (35215496), (35215499), (35215502), (35215505), (35215508), (35215514), (35215517), (35215520), (35215523),
(35215526), (35215532), (35215535), (35215538), (35215541), (35215544), (35215550), (35215553), (35215556), (35215559), (35215562), (35215568), (35215571), (35215574), (35215577), (35215580), (35215586), (35215589), (35215592), (35215595),
(35215598), (35215604), (35215607), (35215610), (35215613), (35215616), (35215622), (35215625), (35215628), (35215631), (35215634), (35215640), (35215643), (35215646), (35215649), (35215652), (35215658), (35215661), (35215664), (35215667),
(35215670), (35215676), (35215679), (35215682), (35215685), (35215688), (35215694), (35215697), (35215700), (35215703), (35215706), (35215712), (35215715), (35215718), (35215721), (35215724), (35215730), (35215733), (35215736), (35215739),
(35215742), (35215748), (35215751), (35215754), (35215757), (35215760), (35215766), (35215769), (35215772), (35215775), (35215778), (35215784), (35215787), (35215790), (35215793), (35215796), (35215802), (35215805), (35215808), (35215811),
(35215814), (35215820), (35215823), (35215826), (35215829), (35215832), (35215838), (35215841), (35215844), (35215847), (35215850), (35215856), (35215859), (35215862), (35215865), (35215868), (35215874), (35215877), (35215880), (35215883),
(35215886), (35215892), (35215895), (35215898), (35215901), (35215904), (35215910), (35215913), (35215916), (35215919), (35215922), (35215928), (35215931), (35215934), (35215937), (35215940), (35215946), (35215949), (35215952), (35215955),
(35215958), (35215964), (35215967), (35215970), (35215973), (35215976), (35215982), (35215985), (35215988), (35215991), (35215994), (35216003), (35216006), (35216009), (35216012), (35216018), (35216021), (35216024), (35216027), (35216030),
(35216036), (35216039), (35216042), (35216045), (35216048), (35216054), (35216057), (35216060), (35216063), (35216066), (35216072), (35216075), (35216078), (35216081), (35216084), (35216090), (35216093), (35216096), (35216099), (35216102),
(35216108), (35216111), (35216114), (35216117), (35216120), (35216126), (35216129), (35216132), (35216135), (35216138), (35216144), (35216147), (35216150), (35216153), (35216156), (35216162), (35216165), (35216168), (35216171), (35216174),
(35216180), (35216183), (35216186), (35216189), (35216192), (35216198), (35216201), (35216204), (35216207), (35216210), (35216216), (35216219), (35216222), (35216225), (35216228), (35216234), (35216237), (35216240), (35216243), (35216246),
(35216252), (35216255), (35216258), (35216261), (35216264), (35216288), (35216291), (35216294), (35216297), (35216300), (35216306), (35216309), (35216312), (35216315), (35216318), (35216324), (35216327), (35216330), (35216333), (35216336),
(35216360), (35216363), (35216366), (35216369), (35216372), (35216374), (35216378), (35216381), (35216384), (35216387), (35216390), (35216396), (35216399), (35216402), (35216405), (35216408), (35216414), (35216417), (35216420), (35216423),
(35216426), (35216432), (35216435), (35216438), (35216441), (35216444), (35216450), (35216453), (35216456), (35216459), (35216462), (35216468), (35216471), (35216474), (35216477), (35216480), (35216486), (35216489), (35216492), (35216495),
(35216498), (35216504), (35216507), (35216510), (35216513), (35216516), (35216522), (35216525), (35216528), (35216531), (35216534), (35216540), (35216543), (35216546), (35216549), (35216552), (35216558), (35216561), (35216564), (35216567),
(35216570), (35216576), (35216579), (35216582), (35216585), (35216588), (35216589), (35216590), (35216594), (35216597), (35216600), (35216603), (35216606), (35216612), (35216615), (35216618), (35216621), (35216624), (35216630), (35216633),
(35216636), (35216639), (35216642), (35216648), (35216651), (35216654), (35216657), (35216660), (35216666), (35216669), (35216672), (35216675), (35216678), (35216684), (35216687), (35216690), (35216693), (35216696), (35216702), (35216705),
(35216708), (35216711), (35216714), (35216720), (35216723), (35216726), (35216729), (35216732), (35216738), (35216741), (35216744), (35216747), (35216750), (35216752), (35216756), (35216759), (35216762), (35216765), (35216768), (35216774),
(35216777), (35216780), (35216783), (35216786), (35216792), (35216795), (35216798), (35216801), (35216804), (35216810), (35216813), (35216816), (35216819), (35216822), (35216828), (35216831), (35216834), (35216837), (35216840), (35216846),
(35216849), (35216852), (35216855), (35216858), (35216864), (35216867), (35216870), (35216873), (35216876), (35216882), (35216885), (35216888), (35216891), (35216894), (35216900), (35216903), (35216906), (35216909), (35216912), (35216918),
(35216921), (35216924), (35216927), (35216930), (35216936), (35216939), (35216942), (35216945), (35216948), (35216954), (35216957), (35216960), (35216963), (35216966), (35216972), (35216975), (35216978), (35216981), (35216984), (35216990),
(35216993), (35216996), (35216999), (35217002), (35217008), (35217011), (35217014), (35217017), (35217020), (35217026), (35217029), (35217032), (35217035), (35217038), (35217044), (35217047), (35217050), (35217053), (35217056), (35217062),
(35217065), (35217068), (35217071), (35217074), (35217080), (35217083), (35217086), (35217089), (35217092), (35217098), (35217101), (35217104), (35217107), (35217110), (35217116), (35217119), (35217122), (35217125), (35217128), (35217134),
(35217137), (35217140), (35217143), (35217146), (35217152), (35217155), (35217158), (35217161), (35217164), (35217170), (35217173), (35217176), (35217179), (35217182), (35217188), (35217191), (35217194), (35217197), (35217200), (35217206),
(35217209), (35217212), (35217215), (35217218), (35217224), (35217227), (35217230), (35217233), (35217236), (35217242), (35217245), (35217248), (35217251), (35217254), (35217260), (35217263), (35217266), (35217269), (35217272), (35217278),
(35217281), (35217284), (35217287), (35217290), (35217296), (35217299), (35217302), (35217305), (35217308), (35217314), (35217317), (35217320), (35217323), (35217326), (35217332), (35217335), (35217338), (35217341), (35217344), (35217350),
(35217353), (35217356), (35217359), (35217362), (35217368), (35217371), (35217374), (35217377), (35217380), (35217386), (35217389), (35217392), (35217395), (35217398), (35217404), (35217407), (35217410), (35217413), (35217416), (35217422),
(35217425), (35217428), (35217431), (35217434), (35217440), (35217443), (35217446), (35217449), (35217452), (35217458), (35217461), (35217464), (35217467), (35217470), (35217476), (35217479), (35217482), (35217485), (35217488), (35218820),
(35218823), (35218829), (35218853), (35218856), (35218859), (35218860), (35218865), (35218868), (35218871), (35218877), (35218880), (35218883), (35218886), (35218889), (35218892), (35218895), (35218898), (35218899), (35218900), (35218901),
(35218910), (35218913), (35218916), (35218919), (35218931), (35218937), (35218940), (35218943), (35218946), (35218949), (35218952), (35218955), (35218958), (35218961), (35218964), (35218967), (35218970), (35218973), (35218976), (35218979),
(35218982), (35218985), (35218988), (35218991), (35218994), (35218997), (35219000), (35219003), (35219006), (35219009), (35219012), (35219015), (35219018), (35219021), (35219024), (35219027), (35219030), (35219039), (35219045), (35219048),
(35219060), (35219063), (35219066), (35219069), (35219072), (35219075), (35219078), (35219081), (35219084), (35219087), (35219090), (35219093), (35219098), (35219101), (35219102), (35219103), (35219106), (35219129), (35219130), (35219133),
(35219135), (35224713), (35224714), (35224715), (35224716), (35224717), (35224718), (35224719), (35224720), (35224721), (35224722), (35224723), (35224724), (35224725), (35224726), (35224727), (35224728), (35224729), (35224730), (35224731),
(35224732), (35224733), (35224734), (35224735), (35224736), (35224737), (35224738), (35224740), (35224742), (35224804), (35224805), (35224806), (35224807), (35224808), (35224809), (35224810), (35224811), (35224812), (35224813), (35224814),
(35224815), (35224816), (35224817), (35224818), (35224819), (35224820), (35224821), (35224822), (36712821), (36712827), (37016820), (37018489), (37018495), (37019123), (37116361), (37201937), (37398951), (40273881), (40337307), (40353121),
(40374911), (40377027), (40392492), (40409739), (40410146), (40410225), (40414902), (40414905), (40414912), (40414916), (40414917), (40414925), (40414926), (40419855), (40419902), (40421688), (40421689), (40421730), (40421752), (40425371),
(40425384), (40425387), (40425395), (40425396), (40425408), (40425409), (40425413), (40425422), (40425432), (40426271), (40426272), (40426273), (40426279), (40426643), (40426644), (40426649), (40426650), (40426651), (40426654), (40479196),
(40479572), (40479573), (40479615), (40480077), (40480515), (40482236), (40483111), (40483172), (40483734), (40485376), (40486354), (40486503), (40488580), (40490404), (40521084), (40536539), (40537695), (40543802), (40567780), (40598703),
(40599145), (40611982), (40615584), (40617620), (40618261), (40619024), (40624020), (40633007), (40638741), (40643675), (42709887), (43020458), (43020459), (43021246), (43021248), (43021250), (43021254), (43021258), (43021410), (43021830),
(43021974), (43021985), (43021989), (43022016), (43022062), (43530680), (44782821), (44782822), (44782987), (44783030), (44783281), (44783518), (44784541), (44793442), (44794862), (44796386), (44796518), (44796547), (44796548), (44797876),
(44797979), (44798732), (44798780), (44798950), (44799080), (44801090), (44801095), (44801096), (44820033), (44820232), (44820233), (44820234), (44820235), (44820237), (44820239), (44820240), (44820241), (44820242), (44820243), (44820244),
(44820255), (44820258), (44820259), (44820260), (44820262), (44820263), (44820264), (44820313), (44820314), (44820331), (44820332), (44820333), (44820334), (44820335), (44820336), (44820337), (44820338), (44820339), (44820340), (44820341),
(44820342), (44820343), (44820345), (44820710), (44821391), (44821392), (44821394), (44821395), (44821396), (44821397), (44821398), (44821399), (44821400), (44821403), (44821409), (44821410), (44821411), (44821412), (44821413), (44821414),
(44821439), (44821440), (44821441), (44821444), (44821445), (44821461), (44821462), (44821463), (44821464), (44821465), (44821466), (44821467), (44821468), (44821469), (44821470), (44821471), (44822501), (44822502), (44822503), (44822506),
(44822507), (44822508), (44822510), (44822511), (44822512), (44822513), (44822514), (44822521), (44822522), (44822523), (44822524), (44822525), (44822526), (44822527), (44822528), (44822529), (44822569), (44822581), (44822582), (44822583),
(44822584), (44822585), (44822586), (44822605), (44822608), (44822609), (44822610), (44822611), (44822612), (44822613), (44822614), (44822615), (44822617), (44823625), (44823626), (44823627), (44823628), (44823629), (44823630), (44823631),
(44823632), (44823633), (44823634), (44823635), (44823636), (44823637), (44823639), (44823640), (44823641), (44823649), (44823650), (44823651), (44823652), (44823653), (44823655), (44823656), (44823659), (44823660), (44823706), (44823707),
(44823711), (44823712), (44823713), (44823714), (44823715), (44823716), (44823717), (44823718), (44823719), (44823738), (44823739), (44823740), (44823741), (44823742), (44823743), (44823744), (44823745), (44823746), (44823747), (44823748),
(44823749), (44823750), (44823751), (44823752), (44823753), (44823754), (44824321), (44824476), (44824813), (44824814), (44824816), (44824817), (44824818), (44824819), (44824820), (44824821), (44824822), (44824823), (44824824), (44824825),
(44824826), (44824827), (44824829), (44824830), (44824831), (44824842), (44824843), (44824844), (44824846), (44824847), (44824848), (44824849), (44824850), (44824851), (44824852), (44824853), (44824891), (44824895), (44824896), (44824912),
(44824913), (44824914), (44824915), (44824916), (44824917), (44824918), (44824921), (44824922), (44826012), (44826013), (44826015), (44826016), (44826017), (44826019), (44826020), (44826027), (44826028), (44826030), (44826031), (44826032),
(44826033), (44826034), (44826035), (44826036), (44826037), (44826038), (44826039), (44826040), (44826041), (44826042), (44826043), (44826083), (44826084), (44826087), (44826088), (44826089), (44826090), (44826091), (44826092), (44826109),
(44826111), (44826112), (44826113), (44826115), (44826116), (44826488), (44826489), (44827105), (44827151), (44827152), (44827153), (44827154), (44827156), (44827157), (44827158), (44827160), (44827162), (44827163), (44827164), (44827165),
(44827166), (44827183), (44827184), (44827185), (44827186), (44827187), (44827188), (44827189), (44827190), (44827220), (44827221), (44827222), (44827234), (44827235), (44827237), (44827248), (44827249), (44827251), (44827252), (44827253),
(44827254), (44827255), (44827257), (44827258), (44827259), (44827260), (44827261), (44827262), (44827263), (44827264), (44827265), (44827642), (44827643), (44827864), (44828325), (44828326), (44828327), (44828328), (44828329), (44828330),
(44828331), (44828332), (44828345), (44828346), (44828347), (44828349), (44828350), (44828351), (44828352), (44828353), (44828354), (44828356), (44828358), (44828360), (44828361), (44828362), (44828363), (44828364), (44828400), (44828401),
(44828402), (44828407), (44828408), (44828409), (44828410), (44828411), (44828412), (44828426), (44828427), (44828428), (44828429), (44828430), (44828431), (44828432), (44828433), (44828434), (44828435), (44828438), (44828439), (44828440),
(44828441), (44828442), (44828443), (44828444), (44828445), (44828446), (44829453), (44829454), (44829455), (44829456), (44829457), (44829458), (44829459), (44829461), (44829462), (44829464), (44829465), (44829476), (44829477), (44829478),
(44829479), (44829480), (44829481), (44829482), (44829483), (44829484), (44829486), (44829487), (44829488), (44829518), (44829519), (44829520), (44829521), (44829522), (44829523), (44829527), (44829528), (44829529), (44829531), (44829532),
(44829533), (44829534), (44829535), (44829536), (44829548), (44829549), (44829551), (44829552), (44829553), (44829554), (44829555), (44830148), (44830272), (44830613), (44830614), (44830616), (44830617), (44830619), (44830632), (44830633),
(44830634), (44830635), (44830636), (44830637), (44830638), (44830639), (44830640), (44830641), (44830642), (44830643), (44830675), (44830676), (44830677), (44830681), (44830682), (44830683), (44830684), (44830697), (44830698), (44830699),
(44830701), (44830702), (44830703), (44830704), (44830705), (44830706), (44831082), (44831761), (44831762), (44831763), (44831764), (44831765), (44831766), (44831767), (44831768), (44831769), (44831770), (44831771), (44831772), (44831773),
(44831774), (44831775), (44831776), (44831777), (44831778), (44831790), (44831791), (44831792), (44831793), (44831794), (44831795), (44831797), (44831799), (44831800), (44831801), (44831802), (44831803), (44831804), (44831836), (44831837),
(44831838), (44831842), (44831843), (44831844), (44831845), (44831846), (44831847), (44831848), (44831849), (44831868), (44831869), (44831870), (44831871), (44831872), (44831873), (44831874), (44832221), (44832460), (44832900), (44832901),
(44832902), (44832903), (44832904), (44832905), (44832906), (44832907), (44832908), (44832909), (44832910), (44832911), (44832912), (44832929), (44832931), (44832932), (44832974), (44832975), (44832976), (44832977), (44832978), (44832979),
(44832980), (44832984), (44832985), (44832986), (44832988), (44832989), (44833006), (44833007), (44833008), (44833009), (44833010), (44833911), (44834061), (44834098), (44834099), (44834100), (44834101), (44834102), (44834103), (44834104),
(44834105), (44834106), (44834107), (44834108), (44834109), (44834111), (44834112), (44834123), (44834124), (44834125), (44834126), (44834158), (44834159), (44834161), (44834162), (44834169), (44834170), (44834171), (44834172), (44834174),
(44834175), (44834187), (44834188), (44834189), (44834190), (44834191), (44834193), (44834582), (44834583), (44835276), (44835277), (44835279), (44835280), (44835281), (44835282), (44835287), (44835292), (44835293), (44835294), (44835295),
(44835296), (44835297), (44835298), (44835299), (44835300), (44835302), (44835303), (44835304), (44835333), (44835334), (44835335), (44835336), (44835337), (44835338), (44835346), (44835368), (44835369), (44835370), (44835371), (44835372),
(44835373), (44835374), (44835375), (44835377), (44835378), (44835379), (44835380), (44835381), (44835382), (44836467), (44836468), (44836469), (44836470), (44836471), (44836472), (44836473), (44836475), (44836476), (44836487), (44836488),
(44836490), (44836493), (44836494), (44836496), (44836524), (44836526), (44836535), (44836536), (44836537), (44836561), (44836562), (44836563), (44836564), (44836565), (44836566), (44836567), (44836568), (44836569), (44836570), (44836571),
(44836572), (44836957), (44836958), (44837301), (44837608), (44837609), (44837610), (44837611), (44837612), (44837613), (44837614), (44837615), (44837616), (44837617), (44837619), (44837620), (44837621), (44837622), (44837623), (44837624),
(44837625), (44837634), (44837636), (44837637), (44837638), (44837671), (44837673), (44837674), (44837675), (44837680), (44837681), (44837683), (44837684), (44837685), (44837686), (44837687), (44837688), (44837706), (44837709), (44837710),
(44837711), (44837712), (44837713), (44837714), (44837715), (44837716), (44837717), (44837718), (45532999), (45533000), (45533067), (45533069), (45533078), (45533087), (45533089), (45533372), (45533533), (45533534), (45533535), (45533562),
(45533639), (45534150), (45534152), (45534153), (45536667), (45536669), (45536674), (45536682), (45536683), (45536687), (45536689), (45536692), (45536697), (45536704), (45536705), (45536712), (45536713), (45536714), (45536716), (45536719),
(45536720), (45536726), (45536733), (45536736), (45536743), (45536745), (45536762), (45536763), (45536766), (45536768), (45536774), (45536779), (45536786), (45536788), (45536793), (45536794), (45536795), (45536796), (45536802), (45536804),
(45536806), (45536807), (45536812), (45536816), (45536817), (45536818), (45536821), (45536822), (45536831), (45536833), (45536834), (45536836), (45536843), (45536847), (45536848), (45536849), (45536851), (45536856), (45536862), (45536863),
(45536864), (45536865), (45537006), (45537008), (45537026), (45537027), (45537035), (45537039), (45537042), (45537053), (45537063), (45537065), (45537069), (45537090), (45537092), (45537093), (45537584), (45537585), (45537587), (45537937),
(45538012), (45538014), (45538021), (45538029), (45538032), (45538033), (45538035), (45538037), (45538040), (45538045), (45538048), (45538053), (45538488), (45538557), (45538572), (45539077), (45541455), (45541458), (45541461), (45541463),
(45541467), (45541476), (45541478), (45541482), (45541483), (45541485), (45541487), (45541494), (45541497), (45541499), (45541500), (45541501), (45541503), (45541505), (45541511), (45541512), (45541519), (45541520), (45541524), (45541525),
(45541527), (45541530), (45541535), (45541540), (45541542), (45541543), (45541544), (45541547), (45541548), (45541551), (45541561), (45541565), (45541567), (45541569), (45541570), (45541572), (45541578), (45541587), (45541590), (45541598),
(45541611), (45541613), (45541615), (45541616), (45541618), (45541620), (45541621), (45541623), (45541626), (45541633), (45541638), (45541640), (45541642), (45541798), (45541800), (45541803), (45541821), (45541825), (45541836), (45541838),
(45541846), (45541869), (45541870), (45541871), (45541873), (45541887), (45541889), (45541894), (45542363), (45542364), (45542719), (45542793), (45542794), (45542798), (45542800), (45542807), (45542811), (45542812), (45542813), (45542814),
(45542821), (45542826), (45542827), (45542829), (45542831), (45542833), (45542834), (45542918), (45543092), (45543093), (45543094), (45543095), (45543353), (45543905), (45546304), (45546310), (45546315), (45546322), (45546325), (45546334),
(45546340), (45546343), (45546347), (45546352), (45546354), (45546355), (45546356), (45546357), (45546358), (45546361), (45546364), (45546368), (45546370), (45546374), (45546382), (45546383), (45546385), (45546389), (45546390), (45546393),
(45546402), (45546403), (45546404), (45546409), (45546419), (45546421), (45546427), (45546430), (45546432), (45546438), (45546443), (45546451), (45546453), (45546457), (45546459), (45546461), (45546464), (45546467), (45546468), (45546471),
(45546477), (45546486), (45546490), (45546495), (45546506), (45546507), (45546510), (45546680), (45546698), (45546710), (45546711), (45546720), (45546722), (45546725), (45546730), (45546745), (45546748), (45546759), (45546760), (45546763),
(45546764), (45546765), (45547245), (45547246), (45547251), (45547252), (45547253), (45547614), (45547669), (45547683), (45547684), (45547686), (45547687), (45547689), (45547690), (45547691), (45547692), (45547693), (45548176), (45548637),
(45548684), (45548686), (45551123), (45551127), (45551131), (45551134), (45551135), (45551146), (45551148), (45551156), (45551159), (45551163), (45551169), (45551171), (45551172), (45551176), (45551184), (45551193), (45551194), (45551196),
(45551197), (45551201), (45551202), (45551205), (45551207), (45551212), (45551215), (45551216), (45551217), (45551221), (45551222), (45551223), (45551228), (45551231), (45551238), (45551247), (45551249), (45551250), (45551254), (45551256),
(45551257), (45551265), (45551269), (45551274), (45551275), (45551278), (45551282), (45551284), (45551285), (45551287), (45551292), (45551294), (45551299), (45551303), (45551468), (45551470), (45551471), (45551475), (45551476), (45551488),
(45551492), (45551534), (45551542), (45551552), (45551553), (45551554), (45551557), (45551559), (45551560), (45551561), (45552029), (45552030), (45552031), (45552437), (45552441), (45552442), (45552444), (45552449), (45552450), (45552451),
(45552452), (45552453), (45552460), (45552727), (45552728), (45552872), (45552873), (45552902), (45552958), (45552959), (45552960), (45555895), (45555896), (45555897), (45555898), (45555899), (45555902), (45555905), (45555909), (45555916),
(45555917), (45555920), (45555923), (45555936), (45555943), (45555944), (45555951), (45555960), (45555965), (45555969), (45555974), (45555975), (45555977), (45555982), (45555989), (45555992), (45555996), (45556000), (45556003), (45556004),
(45556005), (45556010), (45556014), (45556015), (45556016), (45556018), (45556022), (45556027), (45556034), (45556036), (45556037), (45556048), (45556049), (45556054), (45556060), (45556063), (45556065), (45556068), (45556069), (45556071),
(45556072), (45556074), (45556080), (45556081), (45556083), (45556227), (45556228), (45556230), (45556242), (45556244), (45556252), (45556259), (45556268), (45556270), (45556276), (45556279), (45556290), (45556291), (45556301), (45556302),
(45556304), (45556771), (45556772), (45556773), (45556776), (45556777), (45557162), (45557170), (45557176), (45557177), (45557178), (45557182), (45557184), (45557185), (45557191), (45557264), (45557480), (45557481), (45557482), (45557533),
(45557612), (45557613), (45557684), (45558125), (45560651), (45560655), (45560658), (45560661), (45560671), (45560674), (45560678), (45560681), (45560686), (45560692), (45560695), (45560698), (45560701), (45560702), (45560703), (45560708),
(45560710), (45560718), (45560725), (45560726), (45560727), (45560728), (45560732), (45560734), (45560735), (45560740), (45560746), (45560749), (45560756), (45560757), (45560760), (45560762), (45560767), (45560768), (45560773), (45560774),
(45560777), (45560784), (45560790), (45560791), (45560797), (45560802), (45560806), (45560814), (45560820), (45560827), (45560830), (45560837), (45560839), (45560840), (45560852), (45560864), (45560871), (45561011), (45561015), (45561033),
(45561035), (45561036), (45561048), (45561052), (45561078), (45561080), (45561081), (45561087), (45561100), (45561103), (45561104), (45561105), (45561106), (45561577), (45561584), (45562007), (45562013), (45562015), (45562027), (45562028),
(45562030), (45562031), (45562032), (45562033), (45562114), (45562296), (45562298), (45562299), (45562472), (45562473), (45562506), (45562518), (45562520), (45562547), (45562991), (45565477), (45565478), (45565486), (45565489), (45565490),
(45565493), (45565498), (45565508), (45565509), (45565510), (45565511), (45565516), (45565522), (45565523), (45565526), (45565533), (45565541), (45565546), (45565562), (45565565), (45565572), (45565573), (45565575), (45565578), (45565579),
(45565586), (45565590), (45565597), (45565600), (45565604), (45565610), (45565612), (45565618), (45565627), (45565631), (45565634), (45565637), (45565642), (45565646), (45565649), (45565653), (45565655), (45565660), (45565661), (45565667),
(45565673), (45565682), (45565683), (45565686), (45565687), (45565691), (45565693), (45565805), (45565810), (45565825), (45565831), (45565833), (45565843), (45565845), (45565857), (45565860), (45565872), (45565880), (45565881), (45565882),
(45565883), (45565887), (45565898), (45565900), (45565901), (45565902), (45565906), (45566367), (45566371), (45566784), (45566785), (45566787), (45566791), (45566793), (45566798), (45566802), (45566808), (45566812), (45566813), (45566818),
(45566819), (45566827), (45566828), (45566829), (45567106), (45567255), (45567256), (45567257), (45567281), (45567282), (45567876), (45570342), (45570343), (45570348), (45570351), (45570355), (45570356), (45570358), (45570359), (45570360),
(45570364), (45570375), (45570377), (45570384), (45570386), (45570391), (45570397), (45570398), (45570400), (45570402), (45570406), (45570408), (45570417), (45570418), (45570425), (45570426), (45570429), (45570430), (45570433), (45570438),
(45570440), (45570442), (45570444), (45570449), (45570450), (45570454), (45570458), (45570460), (45570464), (45570467), (45570470), (45570473), (45570474), (45570477), (45570482), (45570484), (45570486), (45570501), (45570503), (45570504),
(45570507), (45570510), (45570513), (45570514), (45570518), (45570521), (45570527), (45570532), (45570534), (45570539), (45570550), (45570551), (45570696), (45570720), (45570721), (45570727), (45570729), (45570738), (45570767), (45570773),
(45570775), (45570778), (45570779), (45570784), (45570785), (45571274), (45571275), (45571276), (45571285), (45571714), (45571720), (45571726), (45571731), (45571735), (45571736), (45571738), (45571746), (45571842), (45572022), (45572025),
(45572154), (45572156), (45572739), (45572899), (45575212), (45575220), (45575227), (45575237), (45575240), (45575242), (45575247), (45575251), (45575252), (45575255), (45575258), (45575259), (45575262), (45575264), (45575265), (45575268),
(45575270), (45575273), (45575275), (45575276), (45575277), (45575286), (45575290), (45575306), (45575309), (45575313), (45575314), (45575333), (45575334), (45575336), (45575338), (45575339), (45575345), (45575347), (45575350), (45575355),
(45575361), (45575362), (45575366), (45575373), (45575377), (45575386), (45575387), (45575392), (45575393), (45575396), (45575397), (45575399), (45575400), (45575534), (45575536), (45575552), (45575590), (45575595), (45575608), (45575620),
(45575621), (45575623), (45575624), (45575625), (45575627), (45575628), (45576086), (45576101), (45576102), (45576419), (45576456), (45576502), (45576506), (45576508), (45576511), (45576523), (45576524), (45576526), (45576527), (45576528),
(45576798), (45576860), (45576937), (45576938), (45576963), (45577006), (45577008), (45577052), (45577053), (45577686), (45580052), (45580054), (45580057), (45580059), (45580061), (45580066), (45580068), (45580069), (45580071), (45580077),
(45580082), (45580084), (45580089), (45580092), (45580094), (45580095), (45580098), (45580099), (45580104), (45580105), (45580108), (45580111), (45580119), (45580132), (45580138), (45580141), (45580142), (45580144), (45580145), (45580147),
(45580148), (45580154), (45580157), (45580158), (45580161), (45580170), (45580178), (45580179), (45580180), (45580185), (45580196), (45580200), (45580209), (45580211), (45580214), (45580215), (45580217), (45580219), (45580223), (45580224),
(45580225), (45580227), (45580232), (45580236), (45580239), (45580240), (45580246), (45580381), (45580382), (45580391), (45580398), (45580404), (45580405), (45580407), (45580423), (45580447), (45580448), (45580449), (45580451), (45580452),
(45580454), (45580471), (45580973), (45580975), (45581411), (45581414), (45581417), (45581418), (45581424), (45581431), (45581434), (45581437), (45581438), (45581439), (45581441), (45581442), (45581761), (45581865), (45581918), (45582378),
(45584851), (45584852), (45584856), (45584863), (45584875), (45584876), (45584886), (45584891), (45584899), (45584900), (45584902), (45584904), (45584905), (45584915), (45584916), (45584920), (45584923), (45584924), (45584925), (45584926),
(45584929), (45584930), (45584933), (45584936), (45584942), (45584944), (45584950), (45584951), (45584953), (45584954), (45584960), (45584961), (45584963), (45584965), (45584966), (45584970), (45584975), (45584980), (45584981), (45584983),
(45584984), (45584987), (45584997), (45585002), (45585006), (45585011), (45585016), (45585019), (45585025), (45585026), (45585031), (45585032), (45585033), (45585046), (45585049), (45585052), (45585058), (45585061), (45585216), (45585217),
(45585220), (45585224), (45585232), (45585238), (45585239), (45585241), (45585242), (45585246), (45585250), (45585262), (45585270), (45585273), (45585281), (45585307), (45585313), (45585323), (45585325), (45585326), (45585327), (45585328),
(45585329), (45585330), (45585333), (45585334), (45585761), (45585762), (45586158), (45586199), (45586205), (45586208), (45586212), (45586214), (45586219), (45586222), (45586227), (45586326), (45586564), (45586655), (45586746), (45586748),
(45587223), (45587432), (45589703), (45589706), (45589711), (45589715), (45589720), (45589721), (45589725), (45589727), (45589729), (45589734), (45589737), (45589740), (45589743), (45589751), (45589752), (45589755), (45589757), (45589758),
(45589761), (45589765), (45589766), (45589768), (45589770), (45589778), (45589780), (45589781), (45589782), (45589798), (45589805), (45589810), (45589814), (45589819), (45589823), (45589828), (45589830), (45589831), (45589832), (45589836),
(45589838), (45589846), (45589848), (45589853), (45589855), (45589860), (45589862), (45589863), (45589869), (45589871), (45589873), (45589874), (45589876), (45589878), (45589880), (45589890), (45589891), (45590042), (45590044), (45590047),
(45590048), (45590049), (45590052), (45590068), (45590075), (45590076), (45590083), (45590090), (45590109), (45590112), (45590120), (45590130), (45590131), (45590132), (45590133), (45590134), (45590661), (45590666), (45590667), (45591045),
(45591046), (45591091), (45591102), (45591104), (45591107), (45591109), (45591110), (45591120), (45591122), (45591123), (45591124), (45591126), (45591207), (45591209), (45591613), (45592110), (45592167), (45594579), (45594581), (45594583),
(45594592), (45594594), (45594596), (45594598), (45594599), (45594600), (45594605), (45594607), (45594608), (45594609), (45594611), (45594614), (45594622), (45594627), (45594630), (45594641), (45594648), (45594656), (45594662), (45594663),
(45594666), (45594667), (45594670), (45594672), (45594673), (45594680), (45594681), (45594683), (45594684), (45594686), (45594687), (45594689), (45594693), (45594694), (45594696), (45594699), (45594700), (45594703), (45594707), (45594709),
(45594717), (45594718), (45594725), (45594729), (45594733), (45594734), (45594738), (45594743), (45594747), (45594884), (45594886), (45594895), (45594896), (45594897), (45594913), (45594914), (45594916), (45594917), (45594932), (45594951),
(45594953), (45594956), (45594961), (45594968), (45594970), (45595441), (45595448), (45595856), (45595857), (45595860), (45595864), (45595868), (45595872), (45595875), (45595880), (45595887), (45595888), (45595889), (45595890), (45595891),
(45595892), (45595893), (45596143), (45596144), (45596183), (45596184), (45596273), (45599387), (45599391), (45599394), (45599400), (45599402), (45599406), (45599407), (45599409), (45599423), (45599428), (45599435), (45599445), (45599447),
(45599450), (45599456), (45599462), (45599463), (45599466), (45599468), (45599476), (45599480), (45599484), (45599489), (45599490), (45599497), (45599511), (45599512), (45599515), (45599519), (45599523), (45599524), (45599531), (45599535),
(45599536), (45599537), (45599539), (45599542), (45599543), (45599547), (45599551), (45599552), (45599556), (45599561), (45599566), (45599568), (45599571), (45599573), (45599725), (45599727), (45599730), (45599733), (45599736), (45599743),
(45599757), (45599758), (45599760), (45599770), (45599771), (45599772), (45599773), (45599802), (45599822), (45599823), (45599824), (45599828), (45599829), (45599830), (45599831), (45599834), (45600277), (45600278), (45600279), (45600280),
(45600283), (45600284), (45600709), (45600714), (45600715), (45600720), (45600721), (45600725), (45600726), (45600727), (45600728), (45600729), (45600730), (45600812), (45600974), (45600975), (45600976), (45601232), (45601707), (45601951),
(45604208), (45604209), (45604213), (45604215), (45604218), (45604222), (45604227), (45604229), (45604231), (45604232), (45604235), (45604237), (45604243), (45604246), (45604260), (45604263), (45604274), (45604281), (45604287), (45604292),
(45604293), (45604297), (45604302), (45604309), (45604316), (45604318), (45604319), (45604328), (45604335), (45604336), (45604337), (45604349), (45604350), (45604351), (45604360), (45604369), (45604371), (45604372), (45604374), (45604377),
(45604379), (45604385), (45604386), (45604520), (45604531), (45604533), (45604551), (45604552), (45604556), (45604563), (45604572), (45604579), (45604584), (45604587), (45604588), (45604589), (45604590), (45604592), (45605053), (45605054),
(45605055), (45605056), (45605057), (45605058), (45605062), (45605465), (45605469), (45605471), (45605473), (45605479), (45605480), (45605481), (45605482), (45605483), (45605576), (45605875), (45605876), (45605877), (45605878), (45605904),
(45605994), (45605995), (45606469), (45606527), (45608973), (45608978), (45608985), (45608988), (45608990), (45608996), (45608998), (45609000), (45609001), (45609002), (45609005), (45609015), (45609018), (45609030), (45609032), (45609035),
(45609036), (45609037), (45609042), (45609050), (45609051), (45609060), (45609062), (45609064), (45609066), (45609078), (45609079), (45609080), (45609083), (45609085), (45609091), (45609092), (45609093), (45609097), (45609098), (45609099),
(45609105), (45609108), (45609110), (45609113), (45609123), (45609126), (45609141), (45609145), (45609147), (45609148), (45609149), (45609153), (45609159), (45609299), (45609302), (45609306), (45609307), (45609321), (45609329), (45609334),
(45609337), (45609339), (45609342), (45609345), (45609353), (45609355), (45609361), (45609373), (45609377), (45609392), (45609393), (45609395), (45609396), (45609397), (45609398), (45609401), (45609880), (45757263)) 
v(concept_id);

-- Get iatrogenic codes along with their descendants
SELECT *
INTO #iatrogenic_codes_with_desc
FROM
	(SELECT concept_id
	FROM #iatrogenic_codes
	UNION
	SELECT DISTINCT descendant_concept_id
	FROM #iatrogenic_codes i
	JOIN concept_ancestor ca ON ca.ancestor_concept_id = i.concept_id) x
;

CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 4 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from dbo.CONCEPT where concept_id in (262,9201)
UNION  select c.concept_id
  from dbo.CONCEPT c
  join dbo.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (262,9201)
  and c.invalid_reason is null

) I
) C;
INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 13 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from dbo.CONCEPT where concept_id in (4146943,46274061,4266367,42537960,4112824,4299935,46269706,763011)
UNION  select c.concept_id
  from dbo.CONCEPT c
  join dbo.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4146943,46274061,4266367,42537960,4112824,4299935,46269706,763011)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from dbo.CONCEPT where concept_id in (4042202)
UNION  select c.concept_id
  from dbo.CONCEPT c
  join dbo.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4042202)
  and c.invalid_reason is null

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C;
INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 14 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from dbo.CONCEPT where concept_id in (45757528,4262075)
UNION  select c.concept_id
  from dbo.CONCEPT c
  join dbo.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (45757528,4262075)
  and c.invalid_reason is null

) I
) C;
INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 15 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from dbo.CONCEPT where concept_id in (44789502,37392948,37394408,36676235,3001703,3016424,3038149,3016676,3017256,3020370,2213094,2213181,2213063,2213062,40757077,40756898,4039357,37392223,44806470,37394297,4044987,4039358,37392224,44807860,37394300,4044988,37392761,40653953,40655680,40655681,40655682,40655683,40655684,40655685,40655686,37080282,40655687,40655688,40655689,40655690,4047171,40655691,40484560,3002988,3002646,3003682)
UNION  select c.concept_id
  from dbo.CONCEPT c
  join dbo.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (44789502,37392948,37394408,36676235,3001703,3016424,3038149,3016676,3017256,3020370,2213094,2213181,2213063,2213062,40757077,40756898,4039357,37392223,44806470,37394297,4044987,4039358,37392224,44807860,37394300,4044988,37392761,40653953,40655680,40655681,40655682,40655683,40655684,40655685,40655686,37080282,40655687,40655688,40655689,40655690,4047171,40655691,40484560,3002988,3002646,3003682)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from dbo.CONCEPT where concept_id in (37066972,3002696,3000619,3023674,3001047,3007341,37398130,4201049,37393224,44805899,45757528,37393225,4196405,44805900,4262075,40760327,37048815,37058506,37055728,37040765,37023170,37075082,37041511,37066453,37057346,37054344,37022661,37067997,37028300,37054453,37036578,37078464,37067504,37070652,37048012,37071077,37042025,37024679,37042070,37052164,37037245,37072518,37044556,37025175,37063376,37068553,37045806,37036252,37064420,37037941,37062169,37076139,37034233,37051887,37075960,37022372,37031117,37073627,37057853,37042870,37075259,37030627,37059249,37037961,37047321,37075847,37073492,37056311,37029363,37023424,37073273,37076384,37069805,37026917,37048913,37074405,37040736,37076803,37075491,37072743,40758391,42869813,40758149,3043198,4017924,37050279,3026510,3027889)
UNION  select c.concept_id
  from dbo.CONCEPT c
  join dbo.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (37066972,3002696,3000619,3023674,3001047,3007341,37398130,4201049,37393224,44805899,45757528,37393225,4196405,44805900,4262075,40760327,37048815,37058506,37055728,37040765,37023170,37075082,37041511,37066453,37057346,37054344,37022661,37067997,37028300,37054453,37036578,37078464,37067504,37070652,37048012,37071077,37042025,37024679,37042070,37052164,37037245,37072518,37044556,37025175,37063376,37068553,37045806,37036252,37064420,37037941,37062169,37076139,37034233,37051887,37075960,37022372,37031117,37073627,37057853,37042870,37075259,37030627,37059249,37037961,37047321,37075847,37073492,37056311,37029363,37023424,37073273,37076384,37069805,37026917,37048913,37074405,37040736,37076803,37075491,37072743,40758391,42869813,40758149,3043198,4017924,37050279,3026510,3027889)
  and c.invalid_reason is null

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C;


with primary_events (event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id) as
(
-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM dbo.VISIT_OCCURRENCE vo
JOIN #Codesets codesets on ((vo.visit_concept_id = codesets.concept_id and codesets.codeset_id = 4))
) C

WHERE (C.visit_start_date >= DATEFROMPARTS(2014, 01, 01) and C.visit_start_date <= DATEFROMPARTS(2019, 12, 31))
-- End Visit Occurrence Criteria

  ) E
	JOIN dbo.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events

)
SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM primary_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM primary_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
SELECT 0 as index_id, p.person_id, p.event_id
FROM primary_events P
INNER JOIN
(
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
       C.CONDITION_CONCEPT_ID as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM dbo.CONDITION_OCCURRENCE co
  JOIN #Codesets codesets on ((co.condition_concept_id = codesets.concept_id and codesets.codeset_id = 13))
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,-21,P.START_DATE) AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.END_DATE)
GROUP BY p.person_id, p.event_id
HAVING COUNT(A.TARGET_CONCEPT_ID) >= 1
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
SELECT 1 as index_id, p.person_id, p.event_id
FROM primary_events P
INNER JOIN
(
  -- Begin Measurement Criteria
select C.person_id, C.measurement_id as event_id, C.measurement_date as start_date, DATEADD(d,1,C.measurement_date) as END_DATE,
       C.measurement_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.measurement_date as sort_date
from 
(
  select m.* 
  FROM dbo.MEASUREMENT m
JOIN #Codesets codesets on ((m.measurement_concept_id = codesets.concept_id and codesets.codeset_id = 14))
) C


-- End Measurement Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,-21,P.START_DATE) AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.END_DATE)
GROUP BY p.person_id, p.event_id
HAVING COUNT(A.TARGET_CONCEPT_ID) >= 1
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
SELECT 2 as index_id, p.person_id, p.event_id
FROM primary_events P
INNER JOIN
(
  -- Begin Measurement Criteria
select C.person_id, C.measurement_id as event_id, C.measurement_date as start_date, DATEADD(d,1,C.measurement_date) as END_DATE,
       C.measurement_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.measurement_date as sort_date
from 
(
  select m.* 
  FROM dbo.MEASUREMENT m
JOIN #Codesets codesets on ((m.measurement_concept_id = codesets.concept_id and codesets.codeset_id = 15))
) C

WHERE C.value_as_concept_id in (4126681,45877985,9191,4181412,45879438,45884084)
-- End Measurement Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,-21,P.START_DATE) AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.END_DATE)
GROUP BY p.person_id, p.event_id
HAVING COUNT(A.TARGET_CONCEPT_ID) >= 1
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
SELECT 3 as index_id, p.person_id, p.event_id
FROM primary_events P
INNER JOIN
(
  -- Begin Observation Criteria
select C.person_id, C.observation_id as event_id, C.observation_date as start_date, DATEADD(d,1,C.observation_date) as END_DATE,
       C.observation_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.observation_date as sort_date
from 
(
  select o.* 
  FROM dbo.OBSERVATION o
JOIN #Codesets codesets on ((o.observation_concept_id = codesets.concept_id and codesets.codeset_id = 15))
) C

WHERE C.value_as_concept_id in (4126681,45877985,9191,45884084,4181412,45879438)
-- End Observation Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,-21,P.START_DATE) AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.END_DATE)
GROUP BY p.person_id, p.event_id
HAVING COUNT(A.TARGET_CONCEPT_ID) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) > 0
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

) QE

;

--- Inclusion Rule Inserts

select 0 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_0
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (

-- Begin Demographic Criteria
SELECT 0 as index_id, e.person_id, e.event_id
FROM #qualified_events E
JOIN dbo.PERSON P ON P.PERSON_ID = E.PERSON_ID
WHERE YEAR(E.start_date) - P.year_of_birth >= 18 AND (P.gender_concept_id = 8507 OR P.gender_concept_id = 8532)
GROUP BY e.person_id, e.event_id
-- End Demographic Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 1 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_1
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
SELECT 0 as index_id, p.person_id, p.event_id
FROM #qualified_events P
LEFT JOIN
(
  select PE.person_id, PE.event_id, PE.start_date, PE.end_date, PE.target_concept_id, PE.visit_occurrence_id, PE.sort_date FROM (
-- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM dbo.VISIT_OCCURRENCE vo
JOIN #Codesets codesets on ((vo.visit_concept_id = codesets.concept_id and codesets.codeset_id = 4))
) C


-- End Visit Occurrence Criteria

) PE
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM dbo.VISIT_OCCURRENCE vo
JOIN #Codesets codesets on ((vo.visit_concept_id = codesets.concept_id and codesets.codeset_id = 4))
) C


-- End Visit Occurrence Criteria
) Q
JOIN dbo.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
SELECT 0 as index_id, p.person_id, p.event_id
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM dbo.VISIT_OCCURRENCE vo
JOIN #Codesets codesets on ((vo.visit_concept_id = codesets.concept_id and codesets.codeset_id = 4))
) C


-- End Visit Occurrence Criteria
) Q
JOIN dbo.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
INNER JOIN
(
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
       C.CONDITION_CONCEPT_ID as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM dbo.CONDITION_OCCURRENCE co
  JOIN #Codesets codesets on ((co.condition_concept_id = codesets.concept_id and codesets.codeset_id = 13))
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,-21,P.START_DATE) AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.END_DATE)
GROUP BY p.person_id, p.event_id
HAVING COUNT(A.TARGET_CONCEPT_ID) >= 1
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
SELECT 1 as index_id, p.person_id, p.event_id
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM dbo.VISIT_OCCURRENCE vo
JOIN #Codesets codesets on ((vo.visit_concept_id = codesets.concept_id and codesets.codeset_id = 4))
) C


-- End Visit Occurrence Criteria
) Q
JOIN dbo.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
INNER JOIN
(
  -- Begin Measurement Criteria
select C.person_id, C.measurement_id as event_id, C.measurement_date as start_date, DATEADD(d,1,C.measurement_date) as END_DATE,
       C.measurement_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.measurement_date as sort_date
from 
(
  select m.* 
  FROM dbo.MEASUREMENT m
JOIN #Codesets codesets on ((m.measurement_concept_id = codesets.concept_id and codesets.codeset_id = 14))
) C


-- End Measurement Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,-21,P.START_DATE) AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.END_DATE)
GROUP BY p.person_id, p.event_id
HAVING COUNT(A.TARGET_CONCEPT_ID) >= 1
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
SELECT 2 as index_id, p.person_id, p.event_id
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM dbo.VISIT_OCCURRENCE vo
JOIN #Codesets codesets on ((vo.visit_concept_id = codesets.concept_id and codesets.codeset_id = 4))
) C


-- End Visit Occurrence Criteria
) Q
JOIN dbo.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
INNER JOIN
(
  -- Begin Measurement Criteria
select C.person_id, C.measurement_id as event_id, C.measurement_date as start_date, DATEADD(d,1,C.measurement_date) as END_DATE,
       C.measurement_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.measurement_date as sort_date
from 
(
  select m.* 
  FROM dbo.MEASUREMENT m
JOIN #Codesets codesets on ((m.measurement_concept_id = codesets.concept_id and codesets.codeset_id = 15))
) C

WHERE C.value_as_concept_id in (4126681,45877985,9191,45884084,4181412,45879438)
-- End Measurement Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,-21,P.START_DATE) AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.END_DATE)
GROUP BY p.person_id, p.event_id
HAVING COUNT(A.TARGET_CONCEPT_ID) >= 1
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
SELECT 3 as index_id, p.person_id, p.event_id
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM dbo.VISIT_OCCURRENCE vo
JOIN #Codesets codesets on ((vo.visit_concept_id = codesets.concept_id and codesets.codeset_id = 4))
) C


-- End Visit Occurrence Criteria
) Q
JOIN dbo.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
INNER JOIN
(
  -- Begin Observation Criteria
select C.person_id, C.observation_id as event_id, C.observation_date as start_date, DATEADD(d,1,C.observation_date) as END_DATE,
       C.observation_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.observation_date as sort_date
from 
(
  select o.* 
  FROM dbo.OBSERVATION o
JOIN #Codesets codesets on ((o.observation_concept_id = codesets.concept_id and codesets.codeset_id = 15))
) C

WHERE C.value_as_concept_id in (4126681,45877985,9191,45884084,4181412,45879438)
-- End Observation Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,-21,P.START_DATE) AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.END_DATE)
GROUP BY p.person_id, p.event_id
HAVING COUNT(A.TARGET_CONCEPT_ID) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) > 0
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,-180,P.START_DATE) AND A.START_DATE <= DATEADD(day,-1,P.START_DATE)
GROUP BY p.person_id, p.event_id
HAVING COUNT(A.TARGET_CONCEPT_ID) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

SELECT inclusion_rule_id, person_id, event_id
INTO #inclusion_events
FROM (select inclusion_rule_id, person_id, event_id from #Inclusion_0
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_1) I;
TRUNCATE TABLE #Inclusion_0;
DROP TABLE #Inclusion_0;

TRUNCATE TABLE #Inclusion_1;
DROP TABLE #Inclusion_1;


with cteIncludedEvents(event_id, person_id, start_date, end_date, op_start_date, op_end_date, ordinal) as
(
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

  -- the matching group with all bits set ( POWER(2,# of inclusion rules) - 1 = inclusion_rule_mask
  WHERE (MG.inclusion_rule_mask = POWER(cast(2 as bigint),2)-1)

)
select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM cteIncludedEvents Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,0,end_date) > start_date then DATEADD(day,0,end_date) else start_date end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
with cohort_ends (event_id, person_id, end_date) as
(
	-- cohort exit dates
  -- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

),
first_ends (person_id, start_date, end_date) as
(
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, E.end_date, row_number() over (partition by I.person_id, I.event_id order by E.end_date) as ordinal 
	  from #included_events I
	  join cohort_ends E on I.event_id = E.event_id and I.person_id = E.person_id and E.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
)
select person_id, start_date, end_date
INTO #cohort_rows
from first_ends;

with cteEndDates (person_id, end_date) AS -- the magic
(	
	SELECT
		person_id
		, DATEADD(day,-1 * 0, event_date)  as end_date
	FROM
	(
		SELECT
			person_id
			, event_date
			, event_type
			, MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type ROWS UNBOUNDED PRECEDING) AS start_ordinal 
			, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type) AS overall_ord
		FROM
		(
			SELECT
				person_id
				, start_date AS event_date
				, -1 AS event_type
				, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
			FROM #cohort_rows
		
			UNION ALL
		

			SELECT
				person_id
				, DATEADD(day,0,end_date) as end_date
				, 1 AS event_type
				, NULL
			FROM #cohort_rows
		) RAWDATA
	) e
	WHERE (2 * e.start_ordinal) - e.overall_ord = 0
),
cteEnds (person_id, start_date, end_date) AS
(
	SELECT
		 c.person_id
		, c.start_date
		, MIN(e.end_date) AS end_date
	FROM #cohort_rows c
	JOIN cteEndDates e ON c.person_id = e.person_id AND e.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
)
select person_id, min(start_date) as start_date, end_date
into #final_cohort
from cteEnds
group by person_id, end_date
;

SELECT DISTINCT person_id INTO #target_cohort
FROM #final_cohort;

-- Export person ID, start date, and concept IDs for conditions, drugs, and procedures
SELECT *
INTO #final_data
FROM
(SELECT DISTINCT co.person_id, co.condition_start_date AS date, co.condition_concept_id AS concept_id, co.visit_occurrence_id
FROM condition_occurrence co
JOIN concept c ON co.condition_concept_id = c.concept_id
LEFT JOIN #iatrogenic_codes_with_desc i ON c.concept_id = i.concept_id
WHERE condition_concept_id != 0 
	AND c.domain_id = 'Condition'	-- Make sure we only get conditions from the condition_occurrence table
	AND i.concept_id IS NULL		-- Make sure condition is not an iatrogenic code
	AND person_id in (SELECT person_id FROM #target_cohort)
	AND condition_start_date >= '2014-01-01' AND condition_start_date <= '2019-12-31'
	AND visit_occurrence_id in (SELECT DISTINCT visit_occurrence_id FROM #qualified_events)
UNION ALL
SELECT DISTINCT de.person_id, de.drug_exposure_start_date AS date, de.drug_concept_id AS concept_id, de.visit_occurrence_id
FROM drug_exposure de
JOIN concept c ON de.drug_concept_id = c.concept_id
LEFT JOIN #iatrogenic_codes_with_desc i ON c.concept_id = i.concept_id
WHERE drug_concept_id != 0 
	AND c.domain_id = 'Drug'	-- Make sure we only get conditions from the condition_occurrence table
	AND i.concept_id IS NULL	-- Make sure condition is not an iatrogenic code
	AND person_id in (SELECT person_id FROM #target_cohort)
	AND drug_exposure_start_date >= '2014-01-01' AND drug_exposure_start_date <= '2019-12-31'
	AND visit_occurrence_id in (SELECT DISTINCT visit_occurrence_id FROM #qualified_events)
UNION ALL
SELECT DISTINCT po.person_id, po.procedure_date AS date, po.procedure_concept_id AS concept_id, po.visit_occurrence_id
FROM procedure_occurrence po
JOIN concept c ON po.procedure_concept_id = c.concept_id
LEFT JOIN #iatrogenic_codes_with_desc i ON c.concept_id = i.concept_id
WHERE procedure_concept_id != 0 
	AND c.domain_id = 'Procedure'	-- Make sure we only get conditions from the condition_occurrence table
	AND i.concept_id IS NULL		-- Make sure condition is not an iatrogenic code;
  AND person_id in (SELECT person_id FROM #target_cohort)
  AND procedure_date >= '2014-01-01' AND procedure_date <= '2019-12-31'
	AND visit_occurrence_id in (SELECT DISTINCT visit_occurrence_id FROM #qualified_events)) as tmp
;

:OUT D:\cohd\influenza_narrow_1419.txt
SELECT *
FROM #final_data 

TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;

TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;

TRUNCATE TABLE #iatrogenic_codes;
DROP TABLE #iatrogenic_codes;

TRUNCATE TABLE #iatrogenic_codes_with_desc;
DROP TABLE #iatrogenic_codes_with_desc;

TRUNCATE TABLE #target_cohort;
DROP TABLE #target_cohort;

TRUNCATE TABLE #final_data;
DROP TABLE #final_data;